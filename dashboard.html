<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Electric Tracker - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Smart Electric Tracker</a>
      <div class="d-flex">
        <button id="toggleDark" class="btn btn-secondary me-2">ğŸŒ™</button>
        <button id="logoutBtn" class="btn btn-danger">ç™»å‡º</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <h2 class="page-title">æ­¡è¿, <span id="userName"></span></h2>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card shadow-sm">
          <h5>æœ¬æœˆç¸½é›»è²»</h5>
          <p id="totalCost" class="fs-4 fw-bold">0 å…ƒ</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm">
          <h5>æœ¬æœˆç”¨é›»é‡</h5>
          <p id="totalUsage" class="fs-4 fw-bold">0 åº¦</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm">
          <h5>å¹³å‡å–®åƒ¹</h5>
          <p id="avgPrice" class="fs-4 fw-bold">0 å…ƒ/åº¦</p>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ç´€éŒ„è¡¨å–® -->
    <div class="card mb-4 p-3 shadow-sm">
      <h5>æ–°å¢é›»è²»ç´€éŒ„</h5>
      <form id="recordForm" class="row g-3">
        <div class="col-md-4">
          <input type="month" id="recordMonth" class="form-control" required>
        </div>
        <div class="col-md-2">
          <input type="number" id="recordUsage" class="form-control" placeholder="åº¦æ•¸" required>
        </div>
        <div class="col-md-2">
          <input type="number" id="recordPrice" class="form-control" placeholder="å–®åƒ¹" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">æ–°å¢</button>
        </div>
      </form>
    </div>

    <!-- ç´€éŒ„è¡¨æ ¼ -->
    <div class="card shadow-sm p-3 mb-4">
      <h5>æ­·å²ç´€éŒ„</h5>
      <div class="table-container">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>ç”¨é›»é‡ (åº¦)</th>
              <th>å–®åƒ¹ (å…ƒ/åº¦)</th>
              <th>ç¸½é‡‘é¡ (å…ƒ)</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="recordTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- æŠ˜ç·šåœ– -->
    <div class="card shadow-sm p-3 mb-4">
      <h5>ç”¨é›»è¶¨å‹¢</h5>
      <canvas id="usageChart" height="150"></canvas>
    </div>
  </div>

  <script>
    // ---------- æª¢æŸ¥ç™»å…¥ ----------
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) {
      window.location.href = "index.html";
    } else {
      document.getElementById("userName").textContent = currentUser;
    }

    // ---------- ç™»å‡º ----------
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUser");
      window.location.href = "index.html";
    });

    // ---------- æ·±è‰²æ¨¡å¼åˆ‡æ› ----------
    const toggleDark = document.getElementById("toggleDark");
    toggleDark.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    // ---------- è¼‰å…¥è³‡æ–™ ----------
    let users = JSON.parse(localStorage.getItem("users")) || {};
    let records = users[currentUser].records || [];

    const recordTableBody = document.getElementById("recordTableBody");

    function renderTable() {
      recordTableBody.innerHTML = "";
      let totalCost = 0, totalUsage = 0;
      records.forEach((rec, idx) => {
        const cost = rec.usage * rec.price;
        totalCost += cost;
        totalUsage += parseFloat(rec.usage);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rec.month}</td>
          <td>${rec.usage}</td>
          <td>${rec.price}</td>
          <td>${cost.toFixed(2)}</td>
          <td><span class="btn-delete" data-idx="${idx}">åˆªé™¤</span></td>
        `;
        recordTableBody.appendChild(tr);
      });
      document.getElementById("totalCost").textContent = totalCost.toFixed(2) + " å…ƒ";
      document.getElementById("totalUsage").textContent = totalUsage + " åº¦";
      document.getElementById("avgPrice").textContent = (totalUsage ? (totalCost/totalUsage).toFixed(2) : 0) + " å…ƒ/åº¦";

      // æ›´æ–°åœ–è¡¨
      updateChart();
    }

    // ---------- æ–°å¢ç´€éŒ„ ----------
    document.getElementById("recordForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const month = document.getElementById("recordMonth").value;
      const usage = parseFloat(document.getElementById("recordUsage").value);
      const price = parseFloat(document.getElementById("recordPrice").value);
      records.push({month, usage, price});
      users[currentUser].records = records;
      localStorage.setItem("users", JSON.stringify(users));
      renderTable();
      e.target.reset();
    });

    // ---------- åˆªé™¤ç´€éŒ„ ----------
    recordTableBody.addEventListener("click", (e) => {
      if (e.target.classList.contains("btn-delete")) {
        const idx = e.target.dataset.idx;
        records.splice(idx, 1);
        users[currentUser].records = records;
        localStorage.setItem("users", JSON.stringify(users));
        renderTable();
      }
    });

    // ---------- Chart ----------
    const ctx = document.getElementById("usageChart").getContext("2d");
    let usageChart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label: "ç”¨é›»é‡ (åº¦)", data: [], backgroundColor: "rgba(13,110,253,0.2)", borderColor: "#0d6efd", borderWidth: 2, fill: true }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    function updateChart() {
      usageChart.data.labels = records.map(r => r.month);
      usageChart.data.datasets[0].data = records.map(r => r.usage);
      usageChart.update();
    }

    // ---------- åˆå§‹æ¸²æŸ“ ----------
    renderTable();
  </script>
</body>
</html>
